{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block body %}

<div class="pusher">
  <div class="ui fluid container">
    
    {% include 'project_manager/_breadcrumb.html' with breadcrumb=breadcrumb only %}

    <div class="row">
      <div class="ui segment">
        <div id="board" class="ui cards" style="overflow: auto; display: flex; flex-flow: row nowrap;"></div>
      </div>
    </div>
    
  </div>
</div>
  
<script>
  $('*.ui.dropdown').dropdown();
  const PROJECT_ID = "{{ object.project.id }}";
  const BOARD_ID = "{{ object.id }}";

  const adjustBoardHeight = (boardSelector='#board') => {
    $(boardSelector).height(
      $(window).height()
      -$(boardSelector).offset().top
      -$(boardSelector).css('marginBottom').replace('px', '').replace('-', '')
      // -50
    );
  } 

  const renderBuckets = (containerSelector, buckets) => {
    $(containerSelector).empty();
    buckets.forEach(e => {
      $(containerSelector).append(
        `
        <div class="ui card" style="width: 300px; flex: 0 0 auto; display: flex;">
          <div class="content" style="flex: 0 0 auto;">
            <div class="header">
              ${e.name}
              <div class="ui right floated basic icon top left pointing dropdown button">
                <i class="ellipsis horizontal icon"></i>
                <div class="menu">
                  <div class="item"><i class="add icon"></i>Add new card</div>
                  <div class="divider"></div>
                  <div class="item"><i class="edit icon"></i>Rename this bucket</div>
                  <div class="item"><i class="delete icon"></i>Delete this bucket</div>
                </div>
              </div>
            </div>
          </div>
          <div class="extra content" id="bucket-${e.id}" style="flex: 1 0 auto;">
          </div>
        </div>
        `
      );
      $('.ui.dropdown').dropdown();
      getCards(e.id);
    });
    $(containerSelector).append(`<div class="ui add bucket button" style="flex: 0 0 auto">Add new bucket</div>`);
    
    e = $('.add.bucket.button').siblings().last()
    $('.add.bucket.button').css('marginTop', e.css('marginTop'))
    $('.add.bucket.button').css('marginBottom', e.css('marginBottom'))
    {% comment %} $('.add.bucket.button').height(e.height()); {% endcomment %}
  };

  const renderCards = (containerSelector, cards) => {
    $(containerSelector).empty();
    cards.forEach(e => {
      console.log(e)
      $(containerSelector).append(
        `
        <div class="ui card">
          <div class="content">
            <div class="header">
              ${e.name}
              <div class="ui right floated tiny basic icon button">
                <i class="ellipsis horizontal icon"></i>
              </div>
            </div>
            <div class="meta">
              ${e.description}
            </div>
          </div>
          <div class="extra content">
          </div>
        </div>
        `
      );
    });
  };

  const getBuckets = () => {
    $.get(`/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/buckets/`)
      .done(r => {
        renderBuckets(containerSelector='#board', r);
      })
      .fail(e => { console.error(e) })
      .always()
  };

  const getCards = bucketId => {
    $.get(`/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/buckets/${bucketId}/cards/`)
      .done(r => {
        renderCards(containerSelector=`#bucket-${bucketId}` , r);
      })
      .fail(e => { console.error(e) })
      .always()
  };

  adjustBoardHeight();
  getBuckets();
</script>
{% endblock %}