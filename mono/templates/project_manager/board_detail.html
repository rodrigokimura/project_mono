{% extends "project_manager/base.html" %}
{% load static %}
{% load i18n %}

{% block head %}
  <script src="{% static '/suggest.js' %}"></script>
  <script src="{% static '/caret.js' %}"></script>
  <style>
    .completed.card {
      opacity: .5;
      transition: all 0.5s;
      -webkit-transition: all 0.5s;
      -moz-transition: all 0.5s;
    }
    .completed.card:hover {
      opacity: 1;
    }
    .hidden{
      display: none !important;
    }

    #zoom-button {
      display: none;
    }

    @media only screen and (max-width: 768px) {
      #zoom-button {
        display: block;
        position: fixed;
        bottom: 0;
        right: 1rem;
        z-index: 10;
      }
    }
    .item-checked {
      text-decoration: line-through;
    }
    .delete-item.button {
      transition: .5s;
      opacity: 0;
    }
    .checklist-item:hover .delete-item.button {
      opacity: 1;
    }
    .assignee {
      margin-right: -.75em !important;
      transition: .5s;
    }
    .assignee:hover {
      margin-right: 0 !important;
    }
    .noselect {
      -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
         -khtml-user-select: none; /* Konqueror HTML */
           -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
                user-select: none; /* Non-prefixed version, currently
                                      supported by Chrome, Edge, Opera and Firefox */
    }
    .mention {
      color: #4183c4;
      transition: .5s;
    }
    .mention:hover {
      color: #1e70bf;
    }
    #suggest {
        position: absolute;
        background-color: #FFFFFF;
        border: 1px solid #85b7d9;
        border-radius: .3em;
        // font-size: 90%;
        width: 200px;
        z-index: 2000;
    }
    #suggest div {
        display: block;
        width: 200px;
        overflow: hidden;
        white-space: nowrap;
    }
    #suggest div.select{ /* keydown, keyup */
        color: #FFFFFF;
        background-color: #2185D0;
    }
    #suggest div.over{ /* mouse over */
        background-color: #CCE2FF;
    }
  </style>
  <script>
    if(typeof(String.prototype.trim) === "undefined") {
        String.prototype.trim = () => String(this).replace(/^\s+|\s+$/g, '');
    };
    const PROJECT_ID = "{{ object.project.id }}";
    const BOARD_ID = "{{ object.id }}";
    const USERNAME = "{{ request.user.username }}";
  </script>
{% endblock head %}

{% block menu %}
  <a class="toc item"><i class="sidebar icon"></i></a>
  <a class="refresh item"><i class="refresh icon"></i></a>
  <a class="fullscreen item"><i class="expand alternate icon"></i></a>
  <div class="ui right flowing popup" style="width: 320px; max-height: 300px; overflow-y: auto; margin-right: 1em;">
  </div>
{% endblock menu %}

{% block sidebar %}
  <div class="ui sidebar inverted vertical menu">
    <div class="item">
      <div class="header">{% translate 'Appearance' %}
      </div>
      <div class="menu">
        <div class="item">
          <div class="header">{% translate 'Compact mode' %}</div>
          <div class="ui inverted slider checkbox board-compact">
            <input type="checkbox">
            <label></label>
          </div>
        </div>
        <div class="item">
          <div class="header">{% translate 'Dark mode' %}</div>
          <div class="ui inverted slider checkbox board-dark">
            <input type="checkbox">
            <label></label>
          </div>
        </div>
        <div class="item">
          <div class="header">{% translate 'Bucket width' %}</div>
          <div class="content">
            <div class="ui inverted width labeled slider" id="slider-1"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="item">
      <div class="ui button" id="edit-tags">Edit tags</div>
    </div>
    <script>
      const addNewTagInput = (containerElement) => {
        el = containerElement.append(`
          <form class="ui unstackable form" data-tag-id="" style="width: 100%; margin-bottom: .5em;">
            <div class="" style="display: flex; flex-flow: row nowrap;">
              <input type="hidden" name="id" value="">
              <div style="flex: 0 0 auto; width: 5.5em; display: flex; margin-right: .5em;">
                <select class="ui tag-icon new-tag clearable compact dropdown" data-tag-id="">
                </select>
              </div>
              <div style="flex: 0 0 auto; width: 5.5em; display: flex; margin-right: .5em;">
                <select class="ui tag-color new-tag clearable compact dropdown" data-tag-id="">
                </select>
              </div>
              <div style="flex: 1 1 auto; margin-right: .5em;">
                <input class="tag-name" type="text" placeholder="Name" data-tag-id="">
              </div>
              <div style="">
                <div class="ui icon red delete new-tag button"><i class="delete icon"></i></div>
              </div>
            </div>
          </form>
        `);
        let iconDropdown = $(`.tag-icon.new-tag.dropdown`);
        iconDropdown.dropdown({
          values: [
          {% for icon in icons %}
          {
            "value": "{{ icon.id }}",
            "icon": "{{ icon.markup }}",
          },
          {% endfor %}
          ]
        });
        let colorDropdown = $(`.tag-color.new-tag.dropdown`);
        colorDropdown.dropdown({
          values: [
          {% for color in colors %}
          {
            "value": "{{ color.id }}",
            "icon": "{{ color.name|lower }} circle",
          },
          {% endfor %}
          ]
        });
        el.find('.delete.button.new-tag').off();
        el.find('.delete.button.new-tag').click(e => {
          $(e.target).closest('form').remove();
        })
      }

      const renderTagForms = (containerElement, tag) => {
        containerElement.append(`
          <form class="ui unstackable form" data-tag-id="${tag.id}" style="width: 100%; margin-bottom: .5em;">
            <div class="" style="display: flex; flex-flow: row nowrap;">
              <input type="hidden" name="id" value="${tag.id}">
              <div style="flex: 0 0 auto; width: 5.5em; display: flex; margin-right: .5em;">
                <select class="ui tag-icon clearable compact dropdown" data-tag-id="${tag.id}">
                </select>
              </div>
              <div style="flex: 0 0 auto; width: 5.5em; display: flex; margin-right: .5em;">
                <select class="ui tag-color clearable compact dropdown" data-tag-id="${tag.id}">
                </select>
              </div>
              <div style="flex: 1 1 auto; margin-right: .5em;">
                <input class="tag-name" type="text" placeholder="Name" data-tag-id="${tag.id}">
              </div>
              <div style="">
                <div class="ui icon red delete button" data-tag-id="${tag.id}"><i class="delete icon"></i></div>
              </div>
            </div>
          </form>
        `);
        let iconDropdown = $(`.tag-icon.dropdown[data-tag-id=${tag.id}]`);
        iconDropdown.dropdown({
          values: [
          {% for icon in icons %}
          {
            "value": "{{ icon.id }}",
            "icon": "{{ icon.markup }}",
          },
          {% endfor %}
          ]
        });
        if (tag.icon !== null) {
          iconDropdown.dropdown('set selected', tag.icon.id);
        };
        let colorDropdown = $(`.tag-color.dropdown[data-tag-id=${tag.id}]`);
        colorDropdown.dropdown({
          values: [
          {% for color in colors %}
          {
            "value": "{{ color.id }}",
            "icon": "{{ color.name|lower }} circle",
          },
          {% endfor %}
          ]
        });
        if (tag.color !== null) {
          colorDropdown.dropdown('set selected', tag.color.id);
        };
        $(`input[type=text][data-tag-id=${tag.id}]`).val(tag.name);
        $(`.delete.button[data-tag-id=${tag.id}]`).click(() => {
          $('body').modal({ 
            title: 'Deletion confirmation', 
            class: 'mini', 
            closeIcon: true, 
            content: `Are you sure yo want to delete tag ${tag.name}?`, 
            allowMultiple: true,
            actions: [
              { 
                text: 'Yes', 
                class: 'positive'
              },
              { 
                text: 'Cancel', 
                class: 'deny'
              },
            ],
            onApprove: () => {
              $.ajax({
                url: `/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/${tag.id}`,
                method: 'DELETE',
                headers: {'X-CSRFToken': csrftoken},
              }).done(r => {
                $(`form[data-tag-id=${tag.id}]`).remove();
                loadBoard();
              })
            }
          }).modal('show');
        })
      };
      $('#edit-tags').click(() => {
        // Close sidebar
        $('.ui.sidebar').sidebar('hide');
        let tagsModal = $('.ui.tags.modal');
        tagsModal.modal({
          autofocus: false,
          allowMultiple: true,
          onShow: () => {
            el = tagsModal.find('.scrolling.content');
            el.empty();
            el.append(`
              <div class="ui new-tag icon labeled green button" style="margin-bottom: 1em;">
                <i class="add icon"></i>
                Add new tag
              </div>
            `)
            el.find('.new-tag').click(() => {
              addNewTagInput(el);
            })
            $.get(`/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/`)
              .done(r => {
                for (tag of r) {
                  renderTagForms(el, tag);
                };
              })
              .fail(e => { console.error(e) })
              .always(() => {
              })
          },
          onApprove: () => {
            el.find('.ui.form').each((index, form) => {
              id = $(form).find('input[name=id]').val();
              icon = $(form).find('.tag-icon').dropdown('get value');
              color = $(form).find('.tag-color').dropdown('get value');
              name = $(form).find('.tag-name').val();
              if (id == '') {
                $.ajax({
                  url:`/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/`,
                  method: 'POST',
                  headers: {'X-CSRFToken': csrftoken},
                  data: {
                    icon: icon,
                    color: color,
                    name: name,
                  }
                })
              } else {
                $.ajax({
                  url:`/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/${id}/`,
                  method: 'PUT',
                  headers: {'X-CSRFToken': csrftoken},
                  data: {
                    icon: icon,
                    color: color,
                    name: name,
                  }
                })
              }
            });
            loadBoard();
          },
        });
        tagsModal.modal('show');
      })
    </script>
  </div>
{% endblock sidebar %}

{% block main %}
  <script src="{% static 'js/dragula.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/dragula.min.css' %}">

  <div class="ui primary circular huge teal icon mobile only button" 
    style="margin-bottom: 1rem;"
    id="zoom-button">
    <i class="search minus icon"></i>
  </div>
  <script>
    $('#zoom-button').click(e => {
      let buckets = $('.bucket-el');
      buckets.each(i => {
        let bucket = $(buckets[i]);
        bucket.width('100px');
        if (bucket.hasClass('zoomed-out')) {
          $('#zoom-button').find('i').removeClass('plus').addClass('minus');
          bucket.removeClass('zoomed-out');
          bucket.width('300px');
          bucket.css('font-size', '1em');
          bucket.css('line-height', '20px');
          bucket.find('.dropdown.button').removeClass('mini')
          bucket.find('.label').removeClass('mini')
        } else {
          $('#zoom-button').find('i').removeClass('minus').addClass('plus');
          bucket.addClass('zoomed-out');
          bucket.width('200px');
          bucket.css('font-size', '.6em');
          bucket.css('line-height', '13px');
          bucket.find('.dropdown.button').addClass('mini')
          bucket.find('.label').addClass('mini')
        }
      });
      $('.add.bucket.button').css('font-size', '.6em');
    })
  </script>

  <div class="pusher">
    <div class="ui fluid container">
      {% include 'project_manager/_breadcrumb.html' with breadcrumb=breadcrumb only %}
      <div class="ui basic segment" style="margin:  0;">
        <div id="board" class="ui cards buckets-drake" style="overflow-y: hidden; overflow-x: auto; display: flex; flex-flow: row nowrap; scroll-snap-type: y mandatory; scroll-padding: .8em;"></div>
      </div>
    </div>
  </div>

  <form class="ui card-form tiny top aligned card longer modal form">
    <i class="close icon"></i>
    <div class="header">
      <div class="transparent field">
        <input type=text name="name" placeholder="Name">
      </div>
    </div>
    <div class="scrolling content">
      <div class="field">
        <input type="hidden" name="id">
      </div>
      <div class="field">
        <input type="hidden" name="order">
      </div>
      <div class="field">
        <label>{% translate 'Tags' %}</label>
        <div class="ui tags search multiple selection dropdown">
          <div class="text"></div>
          <i class="dropdown icon"></i>
        </div>
      </div>
      <div class="field">
        <label>{% translate 'Assigned to' %}</label>
        <div class="ui assigned_to search multiple selection dropdown">
          <div class="text"></div>
          <i class="dropdown icon"></i>
        </div>
      </div>
      <script>
        const tagExists = (id) => {
          var exists = false;
          $.ajax({
            method: 'GET',
            headers: {'X-CSRFToken': csrftoken},
            async: false,
            url: `/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/${id}`,
          })
          .done(r => {
            exists = true;
          })
          return exists;
        };
        const createTag = (id, name) => {
          if (!tagExists(id)) {
            $.ajax({
              method: 'POST',
              headers: {'X-CSRFToken': csrftoken},
              async: false,
              url: `/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/`,
              data: {
                name: name
              },
            })
            .done(r => {
              id = r.id;
            })
          }
          return id;
        };
        $('.ui.tags.dropdown').dropdown({
          allowAdditions: true,
          filterRemoteData: true,
          forceSelection: false,
          saveRemoteData: false,
          apiSettings: {
            url: `/pm/api/projects/${PROJECT_ID}/boards/${BOARD_ID}/tags/`,
            method: 'GET',
            cache: false,
            loadingDuration: 500,
            successTest: r => {
              if (r && r.success) {
                return r.success;
              }
              return false;
            },
            onResponse: r => {
              let objs = []
              for (obj of Object.values(r)) {
                obj.value = obj.name;
                if (obj.icon !== null) {
                  obj.icon = obj.icon.markup;
                }
                objs.push(obj);
              }
              return { success: true, results: objs }
            }
          },
        });
      </script>
      <div class="field">
        <label>{% translate 'Description' %}</label>
        <textarea name="description" placeholder="Description" rows="2"></textarea>
      </div>
      <div class="field">
        <label>{% translate 'Status' %}</label>
        <select class="ui status selection dropdown">
          {% for value, text in card_statuses %}
          <option value="{{ value }}">{{ text }}</option>
          {% endfor %}
        </select>
      </div>
      <script>$('.ui.status.dropdown').dropdown();</script>
      <div class="field">
        <label>{% translate 'Color' %}</label>
        <select class="ui card color selection dropdown">
        </select>
      </div>
      <script>
        $('.ui.card.color.dropdown').dropdown({
          clearable: true,
          values: [
            {% for color in colors %}
            {
              "name": "{{ color.name }}",
              "value": {{ color.id }},
              "icon": "{{ color.name|lower }} circle",
            },
            {% endfor %}
          ],
        });
      </script>
      <div class="ui error message"></div>
      <div class="extra content">
        <div class="ui inverted item">
          <div class="ui checklist segment">
            <h4 class="ui dividing header">{% translate 'Checklist' %}</h4>
            <div class="content">
              <div class="checklist-drake"></div>
              <div class="ui fluid transparent icon add-item input">
                <i class="add icon"></i>
                <input type="text" placeholder="Insert new item to checklist">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="ui comments-segment segment">
        <h4 class="ui dividing header">{% translate 'Comments' %}</h4>
        <div class="ui minimal comments" id="card-comments"></div>
        <div class="ui reply form">
          <div class="field">
            <textarea id="suggest-comment" class="add-reply" rows="2" placeholder="Type a new comment"></textarea>
          </div>
          <div id="suggest" style="display:none;"></div>
          <script>
            document.getElementById('suggest-comment').addEventListener('input', function () {
              var caret = getCaretCoordinates(this, this.selectionEnd);
              var fontSize = $('#suggest').css('font-size').replace('px', '');
              scrollHeight = document.getElementById('suggest-comment').scrollTop
              $('#suggest').css({
                top: caret.top - scrollHeight + caret.height, 
                left: caret.left, 
                position: 'absolute'
              });
            })
          </script>
          <div class="ui blue labeled add-reply submit icon button">
            <i class="icon edit"></i> Add comment
          </div>
        </div>
      </div>
    </div>
    <div class="actions">
      <div class="ui black deny labeled icon button"><i class="delete icon"></i>{% translate 'Cancel' %}</div>
      <div class="ui positive right labeled icon button">{% translate 'Save' %}<i class="save icon"></i></div>
    </div>
  </form>
  <script>
    $('form.card.modal').form({
      fields: {
        name: {
          identifier: 'name',
          rules: [
            {
              type   : 'empty',
              prompt : `{% translate "Please, enter a name for your card." %}`
            },
            {
              type   : 'maxLength[50]',
              prompt : `{% translate "Card's name must have less than 50 characters." %}`
            }
          ]
        },
        description: {
          identifier: 'description',
          rules: [
            {
              type   : 'maxLength[255]',
              prompt : `{% translate "Card's description must have less than 255 characters." %}`
            }
          ]
        },
      }
    })
  </script>

  <form class="ui bucket-form tiny top aligned card modal form">
    <i class="close icon"></i>
    <div class="header">
      <div class="field">
        <input type=text name="name" placeholder="Name">
      </div>
    </div>
    <div class="content">
      <div class="field">
        <input type="hidden" name="id">
      </div>
      <div class="field">
        <input type="hidden" name="order">
      </div>
      <div class="field">
        <label>{% translate 'Description' %}</label>
        <textarea name="description" placeholder="Description"></textarea>
      </div>
      <div class="field">
        <label><i class="robot icon"></i>{% translate 'Automatic status' %}</label>
        <select class="ui auto-status selection dropdown">
          {% for value, text in bucket_auto_statuses %}
          <option value="{{ value }}">{{ text }}</option>
          {% endfor %}
        </select>
      </div>
      <script>$('.ui.auto-status').dropdown();</script>
      <div class="field">
        <label>{% translate 'Color' %}</label>
        <select class="ui bucket color selection dropdown">
        </select>
      </div>
      <script>
        $('.ui.bucket.color.dropdown').dropdown({
          clearable: true,
          values: [
            {% for color in colors %}
            {
              "name": "{{ color.name }}",
              "value": {{ color.id }},
              "icon": "{{ color.name|lower }} circle",
            },
            {% endfor %}
          ],
        });
      </script>
      <div class="ui error message"></div>
    </div>
    <div class="actions">
      <div class="ui black deny labeled icon button"><i class="delete icon"></i>{% translate 'Cancel' %}</div>
      <div class="ui positive right labeled icon button">{% translate 'Save' %}<i class="save icon"></i>
      </div>
    </div>
  </form>
  <script>
    $('form.bucket.modal').form({
      fields: {
        name: {
          identifier: 'name',
          rules: [
            {
              type   : 'empty',
              prompt : `{% translate "Please, enter a name for your bucket." %}`
            },
            {
              type   : 'maxLength[50]',
              prompt : `{% translate "Bucket's name must have less than 50 characters." %}`
            }
          ]
        },
        description: {
          identifier: 'description',
          rules: [
            {
              type   : 'maxLength[255]',
              prompt : `{% translate "Bucket's description must have less than 255 characters." %}`
            }
          ]
        },
      }
    })
  </script>

  <div class="ui delete confirmation tiny modal">
    <div class="header"></div>
    <div class="content"></div>
    <div class="actions">
      <div class="ui black cancel button">
        <i class="remove icon"></i>
        {% translate 'No'%}
      </div>
      <div class="ui green ok button">
        <i class="checkmark icon"></i>
        {% translate 'Yes' %}
      </div>
    </div>
  </div>

  <div class="ui comment-edit tiny modal">
    <div class="header">Comment edit</div>
    <div class="content">
      <div class="ui reply form">
        <div class="field">
          <textarea class="comment-edit" rows="2" placeholder="Edit comment"></textarea>
        </div>
      </div>
    </div>
    <div class="actions">
      <div class="ui black cancel button">
        <i class="remove icon"></i>
        {% translate 'Cancel'%}
      </div>
      <div class="ui green ok button">
        <i class="checkmark icon"></i>
        {% translate 'Save' %}
      </div>
    </div>
  </div>

  <div class="ui tags top aligned tiny modal">
    <div class="header"></div>
    <div class="scrolling content">
    </div>
    <div class="actions">
      <div class="ui black cancel button">
        <i class="remove icon"></i>
        {% translate 'Close'%}
      </div>
      <div class="ui green ok button">
        <i class="checkmark icon"></i>
        {% translate 'Save' %}
      </div>
    </div>
  </div>
  <script src="{% static 'board.js' %}"></script>

  <script>    
    $(document).ready(e => {
      $('.ui.sidebar')
        .sidebar('setting', 'transition', 'slide along')
        .sidebar('setting', 'mobileTransition', 'slide along')
        .sidebar('attach events', '.toc.item');
      $('.board-compact.checkbox').checkbox({
        onChecked: () => { setCompact(true); },
        onUnchecked: () => { setCompact(false); },
      });
      $('.board-dark.checkbox').checkbox({
        onChecked: () => { setDarkMode(true); },
        onUnchecked: () => { setDarkMode(false); },
      });
      $('.ui.width.slider').slider({ 
        min: 100, 
        max: 500, 
        step: 100,
        onChange: value => {
          changeBucketWidth(value);
        },
      });
      $('.ui.width.slider').slider('set value', {{ object.bucket_width }}, false);
      
      $('.refresh.item').click(() => { 
        loadBoard();
      });
      $('.fullscreen.item').click(toggleFullscreen);
      {% if object.fullscreen %}setFullscreen(true);{% endif %}
      {% if object.compact %}$('.board-compact.checkbox').checkbox('set checked');{% endif %}
      {% if object.dark %}$('.board-dark.checkbox').checkbox('set checked');{% endif %}
      loadBoard();
    });

  </script>
{% endblock main %}