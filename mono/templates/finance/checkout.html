{% extends "finance/base.html" %}
{% load static %}

{% block head %}
  <style>
    .StripeElement {
      box-sizing: border-box;
  
      height: 3rem;
  
      padding: .8rem;
  
      border: 1px solid #dedede;
      border-radius: 4px;
      background-color: white;
  
      -webkit-transition: box-shadow 150ms ease;
      transition: box-shadow 150ms ease;
    }
  
    .StripeElement--focus {
      border: 1px solid #85b7d7;
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
  
    .StripeElement--invalid {
      border-color: #e0b4b5;
      background-color: #fff7f5 !important;
      color: #9f3a38;
    }
  
    .StripeElement--invalid::-webkit-input-placeholder { /* Webkit */
      color: #e0b4b5;
    }
     
    .StripeElement--invalid:-moz-placeholder { /* Firefox 18-4 */
      color: #e0b4b5;
    }
     
    .StripeElement--invalid::-moz-placeholder {  /* Firefox 19+ */
      color: #e0b4b5;
    }
     
    .StripeElement--invalid:-ms-input-placeholder {  /*  IE10+  */
      color: #e0b4b5;  
    }
  
    .StripeElement--webkit-autofill {
      background-color: #fefde5 !important;
    }
  </style>
  <script src="https://js.stripe.com/v3/"></script>
{% endblock head %}

{% block body %}
<div class="pusher">

  	
  <div class="ui stackable grid container">

    <div class="row">
      <div class="column">
        <div class="ui stackable equal width grid">
          {% for plan in plans %}
          <div class="column">
          
            <div class="ui fluid card" style="overflow: hidden;">
            
              <div class="center aligned content">
                <p><span class="ui big text"><i class="{{ plan.icon }} icon"></i></span></p>
                <div class="header">{{ plan.name }}</div>
              </div>
              
              <div class="content" style="overflow: hidden;">
                {% if plan.type == 'LT' %}
                <div class="ui right orange corner label"><i class="exclamation icon"></i></div>
                {% elif plan.type == 'FR' %}
                <div class="ui top right attached label">Always free!</div>
                {% elif plan.type == 'RC' %}
                <div class="ui right primary corner label"><i class="star icon"></i></div>
                {% endif %}
                {% if plan.feature_set.all %}
                <h4 class="ui sub header">Details</h4>
                <div class="ui list">
                  {% for feature in plan.feature_set.all %}
                  <div class="item">
                    <i class="{{ feature.icon }} icon"></i>
                    <div class="content">
                      {{ feature.short_description }}
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <p>No features to display</p>
                {% endif %}
              </div>
              <div class="ui bottom attached button">Select plan</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <div class="four wide column"></div>
    
    <div class="eight wide column">
      <div class="ui segment">
        <form id="subscription-form" >
          <div class="">
            
            <div id="card-element" style="margin-bottom: 1rem;"></div>
          </div>
          <div id="card-errors" role="alert" class="ui hidden error message"></div>
          <button id="submit" type="submit" class="ui primary button" style="">
            Subscribe
          </button>
        </form>
      </div>
    </div>
    
    <div class="four wide column"></div>
    
  </div>
</div>
<script>

  stripeElements();

  function stripeElements() {
    stripe = Stripe('{{stripe_pk}}', { locale: "{{ request.LANGUAGE_CODE }}" });

    if (document.getElementById('card-element')) {
      let elements = stripe.elements();

      // Card Element styles
      let style = {
        base: {
          color: "#32325d",
          fontFamily: 'Lato,"Helvetica Neue",Arial,Helvetica,sans-serif',
          // fontSmoothing: "antialiased",
          fontSize: "16px",
          "::placeholder": {
            color: "#aab7c4"
          }
        },
        invalid: {
          color: "#9f3a38",
          "::placeholder": {
            color: "#e6bdbb",
          },
          iconColor: "#a03a38",
          ':focus': {
            color: "#9f3a38",
          },
        },
      };

      card = elements.create('card', { style: style });

      card.mount('#card-element');

      card.on('focus', function () {
        let el = document.getElementById('card-errors');
        el.classList.add('focused');
      });

      card.on('blur', function () {
        let el = document.getElementById('card-errors');
        el.classList.remove('focused');
      });

      card.on('change', function (event) {
        displayError(event);
      });
    }

    //we'll add payment form handling here
    let paymentForm = document.getElementById('subscription-form');
    if (paymentForm) {

      paymentForm.addEventListener('submit', function (evt) {
        evt.preventDefault();
        // create new payment method & create subscription
        createPaymentMethod({ card });
      });
    }
  }

  function createPaymentMethod({ card }) {
    let billingName = '{{ request.user.username }}';

    stripe
      .createPaymentMethod({
        type: 'card',
        card: card,
        billing_details: {
          name: billingName,
        },
      })
      .then((result) => {
        if (result.error) {
          displayError(result);
        } else {
          $.api({ 
            action: 'checkout',
            on: 'now',
            method: 'POST',
            serializeForm: true,
            mode: 'same-origin',
            headers: {'X-CSRFToken': csrftoken},
            data:{
              payment_method_id: result.paymentMethod.id,
            },
            onError: function(errorMessage, element, xhr) {
              alert(errorMessage)
            },
            onSuccess: function(response, element, xhr) {
              alert(response)
            }
          })



        {% comment %} fetch("{ url 'payment:create_sub' }", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken':'{{ csrf_token }}',
          },
          // credentials: 'same-origin',
          body: JSON.stringify(paymentParams),
        }).then((response) => {
          return response.json(); 
        }).then((result) => {
          if (result.error) {
            // The card had an error when trying to attach it to a customer
            throw result;
          }
          return result;
        }).then((result) => {
          if (result && result.status === 'active') {
            window.location.href = "{ url 'payment:complete' }";
          } else {
            console.log(result.message)
            if (result.exists) {
              window.location.href = "{ url 'payment:subscription_exists' }";
            }
          };
        }).catch(function (error) {
          window.location.href = "{ url 'payment:failure' }";
          console.log(result.error.message);
          displayError(result.error.message);
        }); {% endcomment %}
        
      }
    });
  }

  let displayError = event => {
  
    let displayError = $('#card-errors');
    if (event.error) {
      displayError.text(event.error.message);
      displayError.removeClass('hidden')
    } else {
      displayError.text('');
      displayError.addClass('hidden')
    }
  }

</script>


{% endblock body %}