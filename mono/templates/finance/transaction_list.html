{% extends "finance/base.html" %}

{% block head %}
  <style type="text/css" media="all">
    .hidden{
      display: none !important;
    }
  </style>
{% endblock head %}

{% block body %}

<div class="ui stackable grid container" style="margin-bottom: 1em;">

  <div class="four wide column">
    <form class="ui fluid form" method="GET" id="filter">
      <div class="field">
        <label>Category</label>
        <div class="ui search selection dropdown" data-name="category">
          <input type="hidden" name="category">
          <div class="text"></div>
          <i class="dropdown icon"></i>
        </div>
      </div>
      <div class="field">
        <label>Account</label>
        <div class="ui search selection dropdown" data-name="account">
          <input type="hidden" name="account">
          <div class="text"></div>
          <i class="dropdown icon"></i>
        </div>
      </div>
      <div class="ui fluid buttons">
        <button class="ui button primary" type="submit" form="filter">Filter</button>
        <a class="ui button" href="{% url 'finance:transactions' %}">Clear</a>
      </div>
    </form>
  </div>

  <div class="eight wide column">
    {% if page_obj.object_list %}
    {% for date in daily_grouped %}
    
    <div class="hidden ui segments" data-date="{{ date.date|date:'Y-m-d' }}">
      <div class="ui secondary grey segment" style="padding: .5em 1em;">
        <div class="ui grid">
          <div class="eight wide column">
            <div style="display:flex; flex-flow: row nowrap;">
              <div style="flex: 0 0 auto;margin-right:.1em;">
                <span class="ui big text">{{ date.date|date:"d" }}</span>
              </div>
              <div style="flex: 0 0 auto; display:flex; flex-flow: column nowrap; 
                margin-top:-.25em;">
                <div style="flex: 0 0 auto;">
                  <span class="ui small text">{{ date.date|date:"b" }}</span>
                </div>
                <div style="flex: 0 0 auto; margin-top: -.5em;">
                  <span class="ui small text">{{ date.date|date:"Y" }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="four wide column" style="display:flex; justify-content:flex-end; align-items:center;">
            <span class="ui green text">
              <strong>
                {{ date.total_income }}
              </strong>
            </span>
          </div>
          <div class="four wide column" style="display:flex; justify-content:flex-end; align-items:center;">
            <span class="ui red text">
              <strong>
                {{ date.total_expense }}
              </strong>
            </span>
          </div>
        </div>
      </div>
      
      {% for transaction in page_obj.object_list %}
      {% if transaction.date == date.date %}
      <script type="text/javascript" charset="utf-8">
        $("[data-date='{{ date.date|date:'Y-m-d' }}']").removeClass("hidden");
      </script>
      <div class="ui segment" style="padding: .5em 1em;">
        <div class="ui grid">
          <div class="eight wide column">
            <span class="ui small label">
              {% if transaction.category %}
              <i class="{{ transaction.category.icon }} icon"></i>
              {{ transaction.category }}
              {% else %}
              <i class="unlink icon"></i>
              No category
              {% endif %}
            </span>
            <br>
            <span class="ui small text">
              {{ transaction.description }}
            </span>
          </div>
          <div class="four wide column" style="display:flex; align-items:center;">
            {{ transaction.account }}
          </div>
          <div class="four wide column" style="display:flex; justify-content:flex-end; align-items:center;">
            <a href="{% url 'finance:transaction_update' pk=transaction.pk %}">
              <span
                {% if transaction.category.type == 'INC' %}
                class="ui green text"
                {% elif transaction.category.type == 'EXP' %}
                class="ui red text"
                {% endif %}
                >
                  {{ transaction.ammount }}
              </span>
            </a>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
    {% endfor %}
    {% endif %}

    {% include "_pagination.html" with page_obj=page_obj %}

  </div>
  
  <div class="four wide column">
    <a class="ui fluid button primary" href="{% url "finance:transaction_create" %}">Add transaction</a>
  </div>

</div>


<script>
  $('.ui.dropdown[data-name=category]').dropdown({
    placeholder: "Select a category",
    forceSelection: false,
    values: [
      {% for c in categories %}
      {
        name: "{{ c.name }}",
        value: {{ c.id }},
        {% if c.id|stringformat:"i" == request.GET.category %}
        selected : true
        {% endif %}
      },
      {% endfor %}
    ]
  });
  $('.ui.dropdown[data-name=account]').dropdown({
    placeholder: "Select an account",
    forceSelection: false,
    values: [
      {% for a in accounts %}
      {
        name: "{{ a.name }}",
        value: {{ a.id }},
        {% if a.id|stringformat:"i" == request.GET.account %}
        selected : true
        {% endif %}
      },
      {% endfor %}
    ]
  });
  $('.message .close').click(function() {
    $(this)
    .closest('.message')
    .transition('fade');
  });
</script>

{% endblock %}