{% extends "pixel/base.html" %}
{% load static %}
{% load i18n %}


{% block head %}
{% endblock head %}

{% block main %}
    
    <div class="ui stackable grid container" style="padding-top: 5em;">
        <div class="row">
            <div class="column">
                <div class="ui header" style="display: flex; flex-flow: row nowrap;">
                    <div style="flex: 1 0 auto;">
                        {% translate "Your pixel tags" %}
                    </div>
                    <a href="" class="ui right floated icon labeled green button" style="flex: 0 0 auto;">
                        <i class="add icon"></i>
                        {% translate "New tag" %}
                    </a>
                </div>
            </div>
        </div>
        {% for site in object_list %}
            <div class="ui card">
                <div class="content">
                    <a class="header" href="{% url 'pixel:dashboard' pk=site.id %}">{{ site.host }}</a>
                    <div class="meta">
                        <span class="date">Created at {{ site.created_at }}</span>
                    </div>
                    <div class="description">
                        {{ site.ping_set.all.count }} pings
                    </div>
                </div>
                <div class="extra content">
                    <button class="ui view-code button" data-site-id="{{ site.id }}">View code</button>
                </div>
            </div>
        {% empty %}
            <div class="ui placeholder segment">
                <div class="ui icon header">
                    <i class="pdf file outline icon"></i>
                    No tags are listed for you.
                </div>
                <div class="ui primary button">Create first tag</div>
            </div>
        {% endfor %}
    </div>

    <div class="ui modal">
        <i class="close icon"></i>
        <div class="header">
            Code snippet
        </div>
        <div class="image content">
            <div class="description">
                <p>Place this on every page you'd like to generate metrics.</p>
                <div class="ui message" style="overflow-x: auto;">
                    <div style="white-space: nowrap;" id="code-snippet"></div>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui button" id="copy-snippet-btn">
                Copy snippet
            </div>
            <div class="ui button" id="download-js-btn">
                Download as Javascript file
            </div>
            <div class="ui button" id="download-html-btn">
                Download as HTML file
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <script>
        snippets = {
            {% for site in object_list %}
            "{{ site.id }}":`{{ site.snippet|escapejs }}`,
            {% endfor %}
        }
        
        function copyCode() {
            var txt = $("#code-snippet").text();
            navigator.clipboard.writeText(txt);
            $('body').toast({
                message: "Code copied!"
            })
        }
        
        function downloadJS() {
            var txt = $("#code-snippet").text()
                .replace("<script>", "")
                .replace("<\/script>", "");
            var a = window.document.createElement('a');
            a.href = window.URL.createObjectURL(new Blob([txt], {type: 'text/javascript'}));
            a.download = 'snippet.js';
            
            // Append anchor to body.
            document.body.appendChild(a);
            a.click();
            
            // Remove anchor from body
            document.body.removeChild(a);
        }
        function downloadHTML() {
            var txt = $("#code-snippet").text();
            var a = window.document.createElement('a');
            a.href = window.URL.createObjectURL(new Blob([txt], {type: 'text/html'}));
            a.download = 'snippet.html';
            
            // Append anchor to body.
            document.body.appendChild(a);
            a.click();
            
            // Remove anchor from body
            document.body.removeChild(a);
        }
        
        $(document).ready(() => {
            $('.view-code').on('click', e => {
                var siteId = $(e.target).attr('data-site-id');
                $("#code-snippet").text(snippets[siteId])
                $('.ui.modal').modal('show');
            })
            $("#copy-snippet-btn").api({
                loadingDuration: 500,
                response: {},
                onComplete: copyCode,
            })
            $("#download-js-btn").api({
                loadingDuration: 500,
                response: {},
                onComplete: downloadJS,
            })
            $("#download-html-btn").api({
                loadingDuration: 500,
                response: {},
                onComplete: downloadHTML,
            })
        })
    </script>
{% endblock %}