{% extends "finance/base.html" %}
{% load static %}
{% comment %} IMPORTANT: it's using Finance app base template {% endcomment %}

{% block head %}
  <style type="text/css">
    .hidden { display: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock head %}

{% block body %}
<div class="pusher">
  <div class="ui grid container">
    <div class="centered row">
      <h1 class="ui header">{{ last_pr }} - Build #{{ last_pr.build_number }}
        <div class="sub header">
          {% if last_pr.deployed %}
          <span>Deployed at: {{ last_pr.deployed_at }}</span>
          {% else %}
          <span>Not deployed yet.</span>
          {% endif %}
        </div>
      </h1>
    </div>
    <div class="centered row">
      <form method="POST" class="ui form">
        {% csrf_token %}
        <input type="hidden" name="pk" value='{{ last_pr.pk }}' >
        <button class="ui huge submit button">
          {% if last_pr.deployed %}
          Redeploy
          {% else %}
          Deploy
          {% endif %}
          <em data-emoji=":rocket:"></em>
        </button>
      </form>
    </div>

    <div class="row">
      <div class="column">
        <div class="ui segment" id="chart-1"></div>
      </div>
    </div>
  </div>
</div>
<script>
  $('.form .submit').api({ 
    action: 'deploy',
    method: 'POST',
    serializeForm: true,
    mode: 'same-origin',
    headers: {'X-CSRFToken': csrftoken},
    data:{
      pk: {{ last_pr.pk }},
    },
    onError: function(errorMessage, element, xhr) {
      alert(errorMessage)
    },
    onSuccess: function(response, element, xhr) {
      window.location.replace(`/hc/deploy/`);
    }
  })

  var options = {
    chart: {
        type: 'line',
        fontFamily: "Lato,'Helvetica Neue',Arial,Helvetica,sans-serif;",
        height: '370px',
    },
    plotOptions: {
        bar: {
            borderRadius: 4,
        }
    },
    series: [
        {
            name: 'Commits',
            data: [
              {% for pr in pull_requests %}
                {{ pr.commits }},
              {% endfor %}
            ],
            type: 'line',
        },
        {
            name: 'Additions',
            data: [
              {% for pr in pull_requests %}
                {{ pr.additions }},
              {% endfor %}
            ],
            type: 'column',
        },
        {
            name: 'Deletions',
            data: [
              {% for pr in pull_requests %}
                {{ pr.deletions }},
              {% endfor %}
            ],
            type: 'column',
        },
        {
            name: 'Changed files',
            data: [
              {% for pr in pull_requests %}
                {{ pr.changed_files }},
              {% endfor %}
            ],
            type: 'column',
        },
    ],
    colors: ['#128FD9', '#00A100', '#FF0000', '#FFB200'],
    xaxis: {
        categories: [
          {% for pr in pull_requests %}
            {{ pr.number }},
          {% endfor %}
        ],
    },
    yaxis: [
        {
            show: false,
            labels: { formatter: v => Math.ceil(v) }
        },
        {
            show: false,
            labels: { formatter: v => Math.ceil(v) }
        },
        {
            show: false,
            labels: { formatter: v => Math.ceil(v) }
        },
        {
            show: false,
            labels: { formatter: v => Math.ceil(v) }
        },
    ],
  }
  // $('.card-chart[data-type=by-date]').empty();
  var chart = new ApexCharts($('#chart-1')[0], options)
  chart.render()
</script>
{% endblock body %}