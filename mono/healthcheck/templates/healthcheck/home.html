{% extends "healthcheck/base.html" %}
{% load static %}
{% load l10n %}

{% block head %}
    <style type="text/css">
        .hidden { display: none; }
        #chart { min-height: 5em; padding: 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock head %}

{% block main %}
    <div class="ui stackable grid container" style="padding-top: 5em;">
        <div class="row">
            <div class="column">
                <div class="ui segment" id="chart"></div>
            </div>
        </div>
        <div class="row">
            <div class="column">
                <div class="ui hidden segments" id="commits"></div>
            </div>
        </div>
    </div>
    <script>
        function renderHeatmap() {
            $.api({
                on: 'now',
                method: 'GET',
                url: '/hc/api/commits/for-heatmap/',
                stateContext: '#chart',
                onSuccess: r => {
                    dateLabels = [
                        r.data_0.map(d => d.d),
                        r.data_1.map(d => d.d),
                        r.data_2.map(d => d.d),
                        r.data_3.map(d => d.d),
                        r.data_4.map(d => d.d),
                        r.data_5.map(d => d.d),
                        r.data_6.map(d => d.d),
                    ]
                    commitSeries = [
                        { name: 'S', data: r.data_0.map(d => d.c) },
                        { name: 'M', data: r.data_1.map(d => d.c) },
                        { name: 'T', data: r.data_2.map(d => d.c) },
                        { name: 'W', data: r.data_3.map(d => d.c) },
                        { name: 'T', data: r.data_4.map(d => d.c) },
                        { name: 'F', data: r.data_5.map(d => d.c) },
                        { name: 'S', data: r.data_6.map(d => d.c) },
                    ].reverse()
                    var chart = new ApexCharts($('#chart')[0], getChartOptions(commitSeries, dateLabels))
                    chart.render()
                },
            })
        }
        function getChartOptions(commitSeries, dateLabels) {
            return {
                series: commitSeries,
                chart: {
                    height: 200,
                    type: 'heatmap',
                    fontFamily: "Lato,'Helvetica Neue',Arial,Helvetica,sans-serif;",
                    events: {
                        dataPointSelection: function(event, chartContext, config) {
                            date = dateLabels[6-config.seriesIndex][config.dataPointIndex]
                            getCommitsByDate(date)
                        }
                    },
                    toolbar: { show: false }
                },
                dataLabels: { enabled: false },
                tooltip: {
                    x: {
                        formatter: (v, o) => dateLabels[6-o.seriesIndex][o.dataPointIndex],
                    },
                },
                
                grid: {
                    show: false,
                    xaxis: { lines: { show: false } },                    
                    yaxis: { lines: { show: false } },                    
                },
                plotOptions: {
                    heatmap: {
                        radius: 4,
                        shadeIntensity: 1,
                        useFillColorAsStroke: false,
                        colorScale: {
                            min: 0,
                        },
                    },
                },
                colors: [ "#008FFB" ],
                title: { show: false },
                xaxis: {
                    labels: { show: false },
                    axisBorder: { show: false },
                },
            }
        }
        function getCommitsByDate(date) {
            $.api({
                on: 'now',
                url: `/hc/api/commits/by-date/?date=${date}`,
                method: 'GET',
                stateContext: '.segment',
                onSuccess: r => {
                    renderCommits(r)
                }
            })
        }
        function toast(msg) {
            $('body').toast({
                title: msg,
                class: 'black',
                showProgress: 'bottom',
                position: 'right bottom',
            })
        }
        function renderCommits(commits) {
            var el = $('#commits')
            el.empty()
            if (commits.length == 0) {
                toast('No commits found.')
                el.hide()
                return
            } else {
                toast(`${commits.length} commits found.`)
            }
            el.show()
            for (var i = 0; i < commits.length; i++) {
                var commit = commits[i]
                var commitEl = $(`
                    <div class="ui segment">
                        <p class="ui header">
                            ${commit.message}
                        </p>
                        <p class="ui meta">
                            <span class="date">${commit.author}</span>
                        </p>
                        <p class="ui meta">
                            <span class="hexsha">${commit.hexsha}</span>
                        </p>
                    </div>
                `)
                el.append(commitEl)
            }
        }
        $(document).ready(e => {
            renderHeatmap()
        })
    </script>
{% endblock main %}