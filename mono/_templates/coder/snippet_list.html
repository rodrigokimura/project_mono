{% extends "coder/base.html" %}
{% load static %}
{% load i18n %}

{% block head %}
    <style>
        {{ snippet_css }}
        .main.grid {
            padding-top: 4em !important;
            padding-left: 21em !important;
            padding-right: 1em !important;
        }
        @media screen and (max-width: 767px) {
            .computer.only {
                display: none !important;
                width: 0 !important;
            }
            .main.grid {
                padding-top: 4em !important;
                padding-left: 1em !important;
                padding-right: 1em !important;
            }
        }
        #code-textarea {
            width: 100%;
            height: 100%;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.42857143;
            color: #
        }
        .snippet.highlight {
            padding: 0 0 0 1em !important;
            overflow: auto;
        }
        .hidden {
            display: none !important;
        }
        /* width */
        ::-webkit-scrollbar {
            width: 10px !important;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1 !important;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888 !important;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555 !important;
        }
    </style>
    <script>
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
          
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
          
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Fallback: Copying text command was ' + msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
          
            document.body.removeChild(textArea);
        }
        function copyTextToClipboard(text) {
            if (!navigator.clipboard) {
                fallbackCopyTextToClipboard(text);
              return;
            }
            navigator.clipboard.writeText(text).then(function() {
                console.log('Async: Copying to clipboard was successful!');
            }, function(err) {
                console.error('Async: Could not copy text: ', err);
            });
        }
    </script>
{% endblock head %}

{% block sidebars %}
    <div class="ui vertical left fixed computer only inverted menu" style="padding-top: 3em; width: 20em;">
        <div class="header item">
            <div class="ui inverted header">
                <em data-emoji=":card_box:" class="small"></em>
                <span style="padding-left: .5em;">Snippets</span>
            </div>
        </div>
        <a class="item" id="show-all" onclick="showAll()">
            Show all
            <div class="ui teal left pointing label" id="count-all"></div>
        </a>
        <div class="item">
            <div class="ui basic fitted languages segment">
                Languages
                <div class="languages inverted menu" style="padding-top: .5em; min-height: 1em;">
                </div>
            </div>
        </div>
        <div class="item">
            Tags
            <div class="menu">
                {% for tag in tags %}
                    <a class="item" data-language="{{ tag }}" onclick="selectTag('{{ tag }}')">
                        {{ tag|title }}
                        <div class="ui label">51</div>
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock sidebars %}

{% block menu %}
    <div class="item">
        Snippets
    </div>
{% endblock menu %}

{% block main %}
    <div class="ui stackable compact main grid">
        <div class="row">
            <div class="four wide column">
                <div class="full height" style="padding: 1px; height: calc(100vh - 5em); display: flex; flex-flow: column nowrap; overflow-y: auto; overflow-x: hidden;">
                    <div class="ui top attached teal segment" style="width: 100%;">
                        <div class="ui fluid input"><input type="text" placeholder="Search..." id="search"></div>
                    </div>
                    <div class="ui bottom attached vertical segment menu snippets" style="padding: 0; width: 100%; flex: 1 0 auto;">
                    </div>
                    <div class="ui fluid green right labeled icon button" style="width: 100%; flex: 0 0 auto;" onclick="showModal()">
                        Add new snippet
                        <i class="add icon"></i>
                    </div>
                </div>
            </div>
            <div class="twelve wide column">
                <div style="display: flex; flex-flow: column nowrap; height: calc(100vh - 5em);" id="snippet"></div>
            </div>
        </div>
    </div>

    <div class="ui modal">
        <i class="close icon"></i>
        <div class="header" id="modal-title"></div>
        <div class="ui form content">
            <div class="field">
                <label>Title</label>
                <input type="text" name="title">
            </div>
            <div class="field">
                <label>Language</label>
                <div class="ui search selection dropdown" id="languages-dropdown">
                    <i class="dropdown icon"></i>
                    <div class="default text">Language</div>
                </div>
            </div>
            <div class="field">
                <label>Code</label>
                <textarea name="code" id="code-textarea" rows=20></textarea>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Cancel
            </div>
            <div class="ui positive right labeled icon button">
                Save
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>

    <script>
        function desselectButtons() {
            $('.menu .item').removeClass('teal').removeClass('active');
        }
        function showAll() {
            desselectButtons();
            button = $('#show-all');
            button.addClass('active');
            getSnippets();
        }
        function selectLanguage(language) {
            desselectButtons();
            button = $(`.menu .item[data-language=${language}]`);
            button.addClass('active');
            getSnippets(filter={'language': language});
        }
        function getSnippetFromStorage(snippetId) {
            snippets = JSON.parse(sessionStorage.getItem('snippets'));
            return snippets.find(snippet => snippet.id == snippetId);
        }
        function selectSnippet(snippetId) {
            desselectButtons();
            button = $(`.menu .item[data-snippet-id=${snippetId}]`);
            button.addClass('teal').addClass('active');
            snippet = getSnippetFromStorage(snippetId);
            let el = $('#snippet');
            el.empty();
            el.append(`
                <div class="ui top attached teal segment" style="flex: 0 0 auto;">
                    <h1 class="ui header">
                        ${snippet.title}
                        <div class="ui right floated red icon button" onclick="deleteSnippet(${snippetId})" data-content="Delete" data-variation="inverted">
                            <i class="delete icon"></i>
                        </div>
                        <div class="ui right floated yellow icon button" onclick="showModal(${snippetId})" data-content="Edit" data-variation="inverted">
                            <i class="edit icon"></i>
                        </div>
                        <div class="ui right floated icon button" onclick="copySnippet(${snippetId})" data-content="Copy" data-variation="inverted">
                            <i class="copy icon"></i>
                        </div>
                        <div class="ui right floated icon button" onclick="shareSnippet(${snippetId})" data-content="Share" data-variation="inverted">
                            <i class="share alternate icon"></i>
                        </div>
                    </h1>
                    <div class="ui header">${snippet.language}</div>
                </div>
                <div class="snippet highlight" style="width: 100%; overflow: auto; padding: 1em; flex: 1 1 auto;">${snippet.html}</div>
                <div class="ui bottom attached segment" style="display: flex; flex-flow: row nowrap; justify-content: space-between; align-items: baseline; width: 100%; padding: .5em; flex: 0 1 auto; margin-bottom: 0;">
                    <div class="ui slider checkbox" id="public-checkbox" style="padding: 1em;">
                        <input type="checkbox" name="newsletter">
                        <label>Public</label>
                    </div>
                    <div class="ui action hidden input" style="flex: 1 0 auto; padding-left: .5em !important; padding-right: .75em !important;" id="public-id">
                        <input type="text" value="${snippet.public_id}">
                        <button class="ui teal right labeled icon button" onclick="copyPublicLink(${snippet.id})">
                            <i class="copy icon"></i>
                            Copy
                        </button>
                    </div>
                </div>
            `);
            $('.icon.button').popup(
                {
                    position: 'top center',
                    inverted: true,
                }
            );
            $('.ui.checkbox').checkbox({
                onChecked: () => { $('#public-id').removeClass('hidden') },
                onUnchecked: () => { $('#public-id').addClass('hidden') },
            });
            if (snippet.public) {
                $('#public-checkbox').checkbox('check');
            }
            console.log(snippet.public);
        }
        function getSnippets(filter = undefined) {
            $('#snippet').empty();
            let url = '/cd/api/snippets/';
            if (filter) {
                url += '?' + $.param(filter);
            }
            $.api({
                on: 'now',
                url: url,
                stateContext: '.snippets',
                onSuccess: function(response) {
                    snippets = response.results;
                    sessionStorage.setItem('snippets', JSON.stringify(snippets));
                    renderSnippets(snippets);
                    if (!filter) { $('#count-all').text(snippets.length); }
                }
            })
        }
        function deleteSnippet(id) {
            $('body').modal({
                title: 'Confirmation',
                class: 'mini',
                closeIcon: true,
                content: 'Are you sure you want to delete this snippet?',
                actions: [
                    {
                        text: 'Cancel',
                         class: 'black deny'
                    },
                    {
                        text: 'Yes, delete it.',
                         class: 'red approve'
                    },
                ],
                onApprove: () => {
                    let url = `/cd/api/snippets/${id}`;
                    $.api({
                        on: 'now',
                        url: url,
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrftoken },
                        stateContext: '.delete.button',
                        onSuccess: function(response) {
                            $('body').toast({
                                title: 'Deletion',
                                message: 'Snippet deleted successfully.'
                            })
                            showAll();
                        }
                    })
                }
            }).modal('show');
        }
        function renderSnippets(snippets) {
            let el = $('.snippets');
            el.empty();
            if (snippets.length > 0) {
                snippets.forEach(snippet => {
                    el.append(`
                        <a class="item" data-snippet-id="${snippet.id}" onclick="selectSnippet('${snippet.id}')">
                            ${snippet.title}
                        </a>
                    `);
                });
            }
        }
        function getLanguages() {
            let el = $('.languages.menu');
            $.api({
                on: 'now',
                url: '/cd/api/snippets/languages/',
                stateContext: '.languages.segment',
                onSuccess: r => {
                    renderLanguages(r);
                }
            })
        }
        function renderLanguages(languages) {
            let el = $('.languages.menu');
            el.empty();
            if (languages.length > 0) {
                languages.forEach(item => {
                    el.append(
                        `
                        <a class="item" data-language="${item.language}" onclick="selectLanguage('${item.language}')" style="padding-right: 0; padding-left: 0;">
                            ${item.language}
                            <div class="ui label">${item.count}</div>
                        </a>
                        `
                    );
                });
            } else {
                el.append(`
                    <div class="ui disabled item" style="padding-right: 0; padding-left: 0;">
                        No languages found
                    </div>
                `);
            }
        }
        function getFormInputData() {
            language = $('#languages-dropdown').dropdown('get value');
            title = $('input[name=title]').val();
            code = $('textarea[name=code]').val();
            return {
                title: title,
                language: language,
                code: code,
            }
        }
        function setFormInputData(snippetId) {
            snippet = getSnippetFromStorage(snippetId);
            $('#languages-dropdown').dropdown('set value', snippet.language);
            $('input[name=title]').val(snippet.title);
            $('textarea[name=code]').val(snippet.code);
        }
        function showModal(id = null) {
            let creation = id === null;
            if (creation) {
                title = 'Creting snippet';
                method = 'POST';
                url = '/cd/api/snippets/';
                resetLanguagesDropdown();
            } else {
                title = 'Editing snippet';
                method = 'PUT';
                url = `/cd/api/snippets/${id}/`;
                setFormInputData(id);
            }
            $('#modal-title').text(title);
            $('.ui.modal')
                .modal({
                    onApprove: () => {
                        $.api({
                            on: 'now',
                            url: url,
                            method: method,
                            headers: { 'X-CSRFToken': csrftoken },
                            data: getFormInputData(),
                            onSuccess: r => {
                                $('body').toast({
                                    title: 'Creation',
                                    message: 'Snippet created successfully.',
                                    class: 'success'
                                });
                                showAll();
                            }
                        })
                    },
                })
                .modal('show');
        }
        function initializeLanguagesDropdown() {
            $('#languages-dropdown').dropdown({
                values: [
                    {% for key, value in languages %}
                        {
                            name: '{{ value }}',
                            value: '{{ key }}',
                            {% if key == 'python' %}
                            selected: true,
                            {% endif %}
                        },
                    {% endfor %}
                ]
            });
        }
        function resetLanguagesDropdown() {
            $('#languages-dropdown').dropdown('restore defaults');
        }
        function copySnippet(snippetId) {
            snippet = getSnippetFromStorage(snippetId);
            copyTextToClipboard(snippet.code);
            $('body').toast({
                title: 'Copying',
                message: 'Snippet copied successfully.',
                class: 'success'
            });
        }
        function copyPublicLink(snippetId) {
            snippet = getSnippetFromStorage(snippetId);
            copyTextToClipboard(`${window.location.origin}/cd/snippet/${snippet.public_id}/`);
            $('body').toast({
                title: 'Copying',
                message: 'Public link copied successfully.',
                class: 'success'
            });
        }
        $(document).ready(e => {
            getLanguages();
            getSnippets();
            initializeLanguagesDropdown();
        });
    </script>
{% endblock %}