<div class="markdownx two columns ui stackable grid">
    <div class="row">
        <div class="column">
            <div style="padding-bottom: 1em; padding-top: 0;">
                <div class="ui icon buttons">
                    <a class="ui button" onclick="buttonCommand(toggleHeading)"><i class="heading icon"></i></a>
                    <a class="ui button" onclick="buttonCommand(toggleBold)"><i class="bold icon"></i></a>
                    <a class="ui button" onclick="buttonCommand(toggleItalic)"><i class="italic icon"></i></a>
                    <a class="ui button" onclick=""><i class="strikethrough icon"></i></a>
                </div>
                <div class="ui icon buttons">
                    <a class="ui button"><i class="list ul icon"></i></a>
                    <a class="ui button"><i class="list ol icon"></i></a>
                </div>
                <div class="ui icon buttons">
                    <a class="ui button"><i class="quote left icon"></i></a>
                    <a class="ui button"><i class="table icon"></i></a>
                    <a class="ui button"><i class="paperclip icon"></i></a>
                    <a class="ui button"><i class="indent icon"></i></a>
                    <a class="ui button"><i class="outdent icon"></i></a>
                </div>
            </div>
            {% include 'django/forms/widgets/textarea.html' %}
        </div>
        <div class="column">
            <div class="markdownx-preview ui segment"></div>
        </div>
    </div>
</div>
<script>
    TEXTAREA = $(`textarea[name="{{ widget.name }}"]`)
    function buttonCommand(command) {
        var curStart = TEXTAREA.prop("selectionStart");
        var curEnd = TEXTAREA.prop("selectionEnd");
        if (curStart != 0 || curEnd != 0) {
            command()
        }
        TEXTAREA.focus()
        TEXTAREA.trigger('input')
    }
    function getSelectedText() {
        var curStart = TEXTAREA.prop("selectionStart");
        var curEnd = TEXTAREA.prop("selectionEnd");
        return [TEXTAREA.val().substring(curStart, curEnd), [curStart, curEnd]]
    }
    function isMultiline(text) {
        return text.indexOf("\n") != -1
    }

    function getSelectedParagraphs(allowPartial = false) {
        var curStart = TEXTAREA.prop("selectionStart");
        var curEnd = TEXTAREA.prop("selectionEnd");
        selectedText = TEXTAREA.val().substring(curStart, curEnd)
        if (allowPartial) {
            if (!isMultiline(selectedText)) {
                return [selectedText, [curStart, curEnd]]
            }
        }
        preText = TEXTAREA.val().substring(0, curStart)
        startPos = preText.lastIndexOf("\n") + 1
        postText = TEXTAREA.val().substring(curEnd)
        if (postText.indexOf("\n") == -1) {
            endPos = TEXTAREA.val().length
        } else {
            endPos = postText.indexOf("\n") + curEnd
        }
        return [TEXTAREA.val().substring(startPos, endPos), [startPos, endPos]]
    }
    function toggleHeading() {
        result = getSelectedParagraphs()
        text = result[0]
        positions = result[1]
        newText = []
        for (p of text.split("\n")) {
            if (p.length == 0) {
                p = ""
            }
            else if (p.startsWith("# ")) {
                p = p.substring(2)
            } else {
                p = "# " + p
            }
            newText.push(p)
        }
        text = newText.join('\n')
        preText = TEXTAREA.val().substring(0, positions[0])
        postText = TEXTAREA.val().substring(positions[1])
        TEXTAREA.val(preText + text + postText)
    }
    function toggleBold() {
        toggleWrapperCommand('**')
    }
    function toggleItalic() {
        toggleWrapperCommand('*')
    }
    function toggleWrapperCommand(symbol) {
        result = getSelectedText()
        text = result[0]
        positions = result[1]
        preText = TEXTAREA.val().substring(0, positions[0])
        postText = TEXTAREA.val().substring(positions[1])
        if (!isMultiline(text)) {
            if (text.startsWith(symbol) && text.endsWith(symbol)) {
                text = text.substring(symbol.length, text.length - symbol.length)
            } else if (preText.endsWith(symbol) && postText.startsWith(symbol)) {
                preText = preText.substring(0, preText.length - symbol.length)
                postText = postText.substring(symbol.length)
             } else {
                text = symbol + text + symbol
            }
        } else {
            newText = []
            for (p of text.split("\n")) {
                if (p.length == 0) {
                    p = ""
                }
                else if (p.startsWith(symbol) && p.endsWith(symbol)) {
                    p = p.substring(symbol.length, p.length - symbol.length)
                } else {
                    p = symbol + p + symbol
                }
                newText.push(p)
            }
            text = newText.join('\n')
        }
        TEXTAREA.val(preText + text + postText)
    }
    function updatePreview() {}
</script>