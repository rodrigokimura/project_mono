{% extends "project_manager/base.html" %}
{% load static %}
{% load i18n %}
{% load custom_tags %}

{% block head %}
    <script src="{% static 'project_manager/project_detail.js' %}"></script>
{% endblock  %}

{% block main %}
<div class="pusher" style="padding-top: 3em;">
    {% include 'project_manager/_breadcrumb.html' with breadcrumb=breadcrumb only %}

    <div class="ui stackable grid container">
    
        <div class="row">
            <div class="column">
                <h2 class="ui header">
                    <i class="columns icon"></i>
                    <div class="content">
                        {% translate "Boards" %}
                        <div class="sub header">{% translate "Boards are where you organize your cards." %}</div>
                    </div>
                </h2>
                {% if boards %}
                    <div class="ui message">
                        {% blocktranslate with project=object.name count counter=boards.count %}
                            You have only one board in project <strong>{{ project }}</strong>.
                        {% plural %}
                            You have {{ counter }} boards in project <strong>{{ project }}</strong>.
                        {% endblocktranslate %}
                    </div>
                    <div class="ui labeled icon floating dropdown button" id="sort-field-dropdown">
                        <i class="sort alphabet down icon"></i>
                        <span class="text">{% translate "Sort" %}</span>
                        <div class="menu">
                            <div class="header">
                                <i class="attention icon"></i>
                                {% translate "Sort boards by" %}
                            </div>
                            <div class="{% if 'name' in request.GET.field %}active {% endif %}item" data-value="name">
                                <i class="text height icon"></i>
                                {% translate "Name" %}
                            </div>
                            <div class="{% if 'created_by' in request.GET.field %}active {% endif %}item" data-value="created_by">
                                <i class="calendar day icon"></i>
                                {% translate "Created by" %}
                            </div>
                        </div>
                    </div>
                    <div class="ui labeled icon floating dropdown button" id="sort-direction-dropdown">
                        <i class="sort icon"></i>
                        <span class="text">{% translate "Direction" %}</span>
                        <div class="menu">
                            <div class="header">
                                <i class="attention icon"></i>
                                {% translate "Sort direction" %}
                            </div>
                            <div class="{% if 'asc' in request.GET.direction %}active {% endif %}item" data-value="asc">
                                <i class="sort up icon"></i>
                                {% translate "Ascending" %}
                            </div>
                            <div class="{% if 'desc' in request.GET.direction %}active {% endif %}item" data-value="desc">
                                <i class="sort down icon"></i>
                                {% translate "Descending" %}
                            </div>
                        </div>
                    </div>
                    <div class="ui four stackable cards" style="margin-top: .5em; padding-top: 0;">
                        {% for board in boards %}
                            <div class="ui card">
                                <div class="content" style="padding-bottom: 0;">
                                    <div class="header" style="display: flex; flex-flow: row nowrap; justify-content: space-between;">
                                        <div class="" style="flex: 0 1 auto; overflow-wrap: anywhere; padding-right: .5em;">
                                            <a href="{% url 'project_manager:board_detail' project_pk=object.id pk=board.pk %}">
                                                {{ board.name }}
                                            </a>
                                        </div>
                                        <div class="ui basic icon top right pointing card-menu dropdown button" style="flex: 0 0 auto; align-self: flex-start;">
                                            <i class="ellipsis horizontal icon"></i>
                                            <div class="menu">
                                                <a class="item" href="{% url 'project_manager:board_detail' project_pk=object.id pk=board.pk %}"><i class="eye icon"></i>{% translate "Open" %}</a>
                                                <a class="item" href="{% url 'project_manager:board_update' project_pk=object.id pk=board.pk %}"><i class="edit icon"></i>{% translate "Edit" %}</a>
                                                <div class="divider"></div>
                                                <a class="delete-board item" data-board-id="{{ board.id }}"><i class="delete icon"></i>{% translate "Delete" %}</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="meta">
                                        <p>{% translate "Created at" %} {{ project.created_at }}</p>
                                    </div>
                                    <div class="description">
                                        <div style="padding-bottom: 1em;">
                                            {% for u in board.allowed_users %}
                                            <img class="ui avatar image" src="{{ u.profile.avatar|default_image }}" alt="" data-content="{{ u.username }}">
                                            {% endfor %}
                                        </div>
                                        {% if board.card_count == 0 %}
                                            <div class="ui tiny multiple progress" data-percent="0" style="padding-bottom: 0;" data-content="{% translate "No cards yet" %}">
                                                <div class="bar"></div>
                                            </div>
                                        {% else %}
                                            <div class="ui tiny multiple progress" data-percent="{% for v, p in board.progress.values %}{{ p }},{% endfor %}" style="padding-bottom: 0;">

                                                {% with board.progress.completed as v %}
                                                    {% if v.0 == 0 %}
                                                    <div class="green bar" data-title="{% translate "Completed" %}" data-content="{% translate "No cards" %}"></div>
                                                    {% elif v.0 == 1 %}
                                                    <div class="green bar" data-title="{% translate "Completed" %}" data-content="{% translate "1 card" %} ({{ v.1 }}%)"></div>
                                                    {% else %}
                                                    <div class="green bar" data-title="{% translate "Completed" %}" data-content="{{ v.0 }} {% translate "cards" %} ({{ v.1 }}%)"></div>
                                                    {% endif %}
                                                {% endwith %}

                                                {% with board.progress.in_progress as v %}
                                                    {% if v.0 == 0 %}
                                                    <div class="yellow bar" data-title="{% translate "In progress" %}" data-content="{% translate "No cards" %}"></div>
                                                    {% elif v.0 == 1 %}
                                                    <div class="yellow bar" data-title="{% translate "In progress" %}" data-content="{% translate "1 card" %} ({{ v.1 }}%)"></div>
                                                    {% else %}
                                                    <div class="yellow bar" data-title="{% translate "In progress" %}" data-content="{{ v.0 }} {% translate "cards" %} ({{ v.1 }}%)"></div>
                                                    {% endif %}
                                                {% endwith %}

                                                {% with board.progress.not_started as v %}
                                                    {% if v.0 == 0 %}
                                                    <div class="grey bar" data-title="{% translate "Not started" %}" data-content="{% translate "No cards" %}"></div>
                                                    {% elif v.0 == 1 %}
                                                    <div class="grey bar" data-title="{% translate "Not started" %}" data-content="{% translate "1 card" %} ({{ v.1 }}%)"></div>
                                                    {% else %}
                                                    <div class="grey bar" data-title="{% translate "Not started" %}" data-content="{{ v.0 }} {% translate "cards" %} ({{ v.1 }}%)"></div>
                                                    {% endif %}
                                                {% endwith %}

                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="ui placeholder segment">
                        <div class="ui icon header">
                            <i class="exclamation triangle icon"></i>
                            {% translate "No boards are listed for this project yet." %}
                        </div>
                        <a href="{% url 'project_manager:board_create' project_pk=object.id %}" class="ui icon labeled animated large green button">
                            <div class="visible content">{% translate "Add your first board!" %}</div>
                            <div class="hidden content"><i class="plus icon"></i></div>
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if boards %}
            <div class="row">
                <div class="column">
                    <a href="{% url 'project_manager:board_create' project_pk=object.id %}" class="ui left floated icon labeled green button">
                        <i class="add icon"></i>{% translate "New board" %}
                    </a>
                </div>
            </div>
        {% endif %}

        <div class="row">
            <div class="column">
                <div class="ui button primary icon labeled button" onclick="showSharingModal()"><i class="share alternate icon"></i>{% translate "Sharing options" %}</div>
            </div>
        </div>
    </div>
</div>

<div class="ui modal" id="sharing-modal">
    <i class="close icon"></i>
    <div class="header">
        {% translate "Sharing options" %}
    </div>
    <div class="content">
        
        <div class="description">
            <div class="ui header">
                {% translate "Your team: " %}
            </div>
            {% if object.assigned_to.all %}
                <div style="overflow-x: auto;">
                    <table class="ui unstackable striped celled single line table">
                        <thead>
                            <tr>
                                <th>{% translate "Name" %}</th>
                                <th>{% translate "Username" %}</th>
                                <th>{% translate "Email" %}</th>
                                <th>{% translate "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in object.assigned_to.all %}
                                <tr>
                                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <div class="ui tiny icon red {% if user == object.created_by %}disabled{% endif %} button" data-content="Remove member from project's team" onclick="removeMember({{ user.id }})"><i class="sign out alternate icon"></i></div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                {% translate "No members yet" %}
            {% endif %}

            <div class="ui header">
                {% translate "Your invites: " %}
            </div>
            <form class="ui invite form">
                <div class="fluid field">
                    <div class="ui fluid action input">
                        <input type="email" name="email" placeholder="Type an email to invite here" class="action invite">
                        <button class="ui teal right labeled icon send invite button" type="submit">
                            <i class="envelope icon"></i>
                            {% translate "Send" %}
                        </button>
                    </div>
                </div>
                <div class="ui error message"></div>
            </form>
            <div id="invites" style="margin-top: 1em;">
            </div>

            <div class="ui header">
                {% translate "Share link: " %}
            </div>
            <div class="ui fluid action input">
                <input class="link" type="text" readonly value="{{ object.share_link }}">
                <button class="ui teal icon copy button">
                    <i class="copy icon"></i>
                </button>
            </div>
            <div id="invites" style="margin-top: 1em;">
            </div>

        </div>
    </div>
    <div class="actions">
        <div class="ui black deny button">
            {% translate "Close" %}
        </div>
    </div>
</div>
  
<script>
    const PROJECT_ID = "{{ object.id }}";
    $(document).ready(() => {
        $('.ui.card-menu.dropdown').dropdown();
        initializeFilterDropdowns();
        $('.ui.progress').progress();
        $('.ui.progress').popup();
        $('.bar').popup();
        $('.ui.avatar.image').popup();
        loadInvites();
    })
</script>
{% endblock %}